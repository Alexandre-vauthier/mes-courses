<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#fafafa">
  <title>Mes Courses</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #fafafa; --bg-secondary: #ffffff; --bg-tertiary: #f4f4f5;
      --text-primary: #18181b; --text-secondary: #52525b; --text-tertiary: #a1a1aa;
      --border-color: #e4e4e7; --accent: #2563eb; --accent-light: #dbeafe;
      --danger: #dc2626; --danger-light: #fee2e2; --success: #16a34a;
      --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px; --radius-full: 9999px;
      --nav-height: 72px;
    }
    html, body, #root { height: 100%; width: 100%; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; }
    .app { height: 100%; display: flex; flex-direction: column; max-width: 480px; margin: 0 auto; background: var(--bg-primary); }
    .app-main { flex: 1; overflow-y: auto; padding-bottom: var(--nav-height); -webkit-overflow-scrolling: touch; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: var(--nav-height); background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; padding: 0 4px; padding-bottom: env(safe-area-inset-bottom, 0); z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 8px; background: none; border: none; cursor: pointer; color: var(--text-tertiary); transition: all 0.2s ease; border-radius: var(--radius-md); }
    .nav-item.active { color: var(--accent); }
    .nav-item.active .nav-icon { background: var(--accent-light); }
    .nav-item.nav-primary .nav-icon { background: var(--accent); color: white; }
    .nav-item.nav-primary .nav-label { color: var(--accent); font-weight: 600; }
    .nav-icon { width: 36px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-full); }
    .nav-icon svg { width: 20px; height: 20px; }
    .nav-label { font-size: 10px; font-weight: 500; }
    .tab-content { padding: 16px; min-height: 100%; }
    .tab-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 20px; position: sticky; top: 0; background: var(--bg-primary); padding: 8px 0; z-index: 10; }
    .tab-header h1 { font-size: 24px; font-weight: 700; flex: 1; }
    .header-actions { display: flex; gap: 8px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; font-size: 14px; font-weight: 600; font-family: inherit; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s ease; white-space: nowrap; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-secondary:hover:not(:disabled) { background: var(--border-color); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-with-icon { padding: 8px 14px; }
    .btn-with-icon svg { width: 18px; height: 18px; }
    .btn-large { width: 100%; padding: 14px 20px; font-size: 16px; border-radius: var(--radius-lg); }
    .btn-large svg { width: 18px; height: 18px; }
    .btn-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: var(--radius-full); font-size: 12px; margin-left: 4px; }
    .btn-icon { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: none; border: none; border-radius: var(--radius-md); cursor: pointer; color: var(--text-secondary); transition: all 0.15s ease; }
    .btn-icon:hover { background: var(--bg-tertiary); }
    .btn-icon svg { width: 22px; height: 22px; }
    .btn-icon-small { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: none; border: none; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-tertiary); transition: all 0.15s ease; }
    .btn-icon-small:hover { background: var(--bg-tertiary); color: var(--text-secondary); }
    .btn-icon-small svg { width: 16px; height: 16px; }
    .btn-icon-danger:hover { background: var(--danger-light); color: var(--danger); }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 24px; text-align: center; }
    .empty-icon { width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: var(--radius-lg); margin-bottom: 16px; color: var(--text-tertiary); }
    .empty-icon svg { width: 32px; height: 32px; }
    .empty-state p { color: var(--text-secondary); margin-bottom: 8px; }
    .empty-hint { font-size: 14px; color: var(--text-tertiary); margin-bottom: 16px !important; }
    .recipes-grid { display: flex; flex-direction: column; gap: 12px; }
    .recipe-card { display: flex; align-items: center; gap: 12px; background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    .recipe-image { width: 72px; height: 72px; flex-shrink: 0; border-radius: var(--radius-md); overflow: hidden; background: var(--bg-tertiary); }
    .recipe-image img { width: 100%; height: 100%; object-fit: cover; }
    .recipe-image-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-tertiary); }
    .recipe-image-placeholder svg { width: 28px; height: 28px; }
    .recipe-info { flex: 1; min-width: 0; }
    .recipe-info h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recipe-ingredients-count { font-size: 13px; color: var(--text-tertiary); }
    .recipe-actions { display: flex; gap: 4px; }
    .form-page { padding: 16px; min-height: 100%; }
    .form-header { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; }
    .form-header h1 { font-size: 20px; font-weight: 600; flex: 1; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .form-group input[type="text"], .form-group select { width: 100%; padding: 12px 14px; font-size: 16px; font-family: inherit; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary); }
    .form-group input[type="text"]:focus, .form-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .search-input { width: 100%; padding: 12px 14px; font-size: 16px; font-family: inherit; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); margin-bottom: 16px; }
    .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .form-actions { display: flex; gap: 12px; margin-top: 32px; padding-bottom: 32px; }
    .form-actions .btn { flex: 1; }
    .image-upload-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; width: 100%; height: 160px; border: 2px dashed var(--border-color); border-radius: var(--radius-lg); color: var(--text-tertiary); cursor: pointer; transition: all 0.15s ease; }
    .image-upload-placeholder:hover { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .image-upload-placeholder svg { width: 32px; height: 32px; }
    .image-upload-placeholder span { font-size: 14px; font-weight: 500; }
    .image-upload-placeholder input { display: none; }
    .image-preview { position: relative; width: 100%; height: 200px; border-radius: var(--radius-lg); overflow: hidden; }
    .image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .btn-remove-image { position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); border: none; border-radius: var(--radius-full); color: white; cursor: pointer; }
    .btn-remove-image svg { width: 16px; height: 16px; }
    .ingredients-selector { max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 12px; background: var(--bg-secondary); }
    .ingredient-group { margin-bottom: 16px; }
    .ingredient-group:last-child { margin-bottom: 0; }
    .ingredient-group h4 { font-size: 12px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .ingredient-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; font-size: 14px; font-family: inherit; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-full); cursor: pointer; transition: all 0.15s ease; color: var(--text-secondary); }
    .chip:hover { border-color: var(--accent); }
    .chip.selected { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }
    .chip-check svg { width: 14px; height: 14px; }
    .ingredients-list { display: flex; flex-direction: column; gap: 16px; }
    .aisle-section { background: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); }
    .aisle-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); }
    .aisle-dot { width: 10px; height: 10px; border-radius: var(--radius-full); background: var(--aisle-color); flex-shrink: 0; }
    .aisle-header h3 { font-size: 14px; font-weight: 600; flex: 1; }
    .aisle-count { font-size: 12px; color: var(--text-tertiary); background: var(--bg-secondary); padding: 2px 8px; border-radius: var(--radius-full); }
    .aisle-items { padding: 4px 0; }
    .ingredient-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border-color); }
    .ingredient-item:last-child { border-bottom: none; }
    .item-actions { display: flex; gap: 2px; opacity: 0.6; }
    .ingredient-item:hover .item-actions, .product-item:hover .item-actions { opacity: 1; }
    .aisles-list { display: flex; flex-direction: column; gap: 8px; }
    .aisle-manager-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color); }
    .aisle-manager-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .aisle-manager-info .aisle-name { font-weight: 500; flex: 1; }
    .aisle-manager-info .aisle-count { font-size: 12px; color: var(--text-tertiary); }
    .color-picker { display: flex; flex-wrap: wrap; gap: 10px; }
    .color-option { width: 40px; height: 40px; border-radius: var(--radius-full); border: 3px solid transparent; cursor: pointer; }
    .color-option.selected { border-color: var(--text-primary); box-shadow: 0 0 0 2px var(--bg-secondary); }
    .products-list { display: flex; flex-direction: column; gap: 16px; }
    .product-group { background: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; }
    .product-group.dragging { opacity: 0.8; transform: scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .group-header { display: flex; align-items: center; padding: 12px 14px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); }
    .group-header h3 { font-size: 14px; font-weight: 600; flex: 1; }
    .drag-handle { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; cursor: grab; color: var(--text-tertiary); margin-right: 8px; touch-action: none; }
    .drag-handle:active { cursor: grabbing; }
    .drag-handle svg { width: 18px; height: 18px; }
    .group-items { padding: 4px 0; }
    .product-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border-color); }
    .product-item:last-child { border-bottom: none; }
    .step-instruction { font-size: 15px; color: var(--text-secondary); margin-bottom: 16px; }
    .recipes-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
    .recipe-select-card { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: var(--radius-lg); cursor: pointer; }
    .recipe-select-card.selected { border-color: var(--accent); background: var(--accent-light); }
    .recipe-select-image { position: relative; width: 100%; aspect-ratio: 1; border-radius: var(--radius-md); overflow: hidden; background: var(--bg-tertiary); }
    .recipe-select-image img { width: 100%; height: 100%; object-fit: cover; }
    .recipe-select-check { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--accent); border-radius: var(--radius-full); color: white; }
    .recipe-select-check svg { width: 14px; height: 14px; }
    .recipe-select-name { font-size: 12px; font-weight: 500; text-align: center; line-height: 1.2; }
    .step-actions { position: sticky; bottom: calc(var(--nav-height) + 16px); padding: 16px 0; background: linear-gradient(transparent, var(--bg-primary) 20%); }
    .recurring-select-list { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .recurring-group h3 { font-size: 13px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .recurring-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; margin-bottom: 6px; }
    .recurring-item:hover { border-color: var(--accent); }
    .recurring-item input { display: none; }
    .checkbox-custom { width: 22px; height: 22px; border: 2px solid var(--border-color); border-radius: var(--radius-sm); flex-shrink: 0; position: relative; }
    .recurring-item input:checked + .checkbox-custom, .shopping-item input:checked + .checkbox-custom { background: var(--accent); border-color: var(--accent); }
    .recurring-item input:checked + .checkbox-custom::after, .shopping-item input:checked + .checkbox-custom::after { content: ''; position: absolute; top: 3px; left: 6px; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .shopping-list { display: flex; flex-direction: column; gap: 16px; padding-bottom: 100px; }
    .shopping-aisle { background: var(--bg-secondary); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); }
    .shopping-aisle-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--bg-tertiary); }
    .shopping-aisle-header h3 { font-size: 14px; font-weight: 600; }
    .shopping-items { padding: 4px 0; }
    .shopping-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
    .shopping-item:last-child { border-bottom: none; }
    .shopping-item input { display: none; }
    .shopping-item .item-name { flex: 1; font-size: 15px; }
    .shopping-item.checked .item-name { text-decoration: line-through; color: var(--text-tertiary); }
    .item-count { font-weight: 600; color: var(--accent); margin-right: 4px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 200; padding: 16px; }
    .modal-content { background: var(--bg-secondary); border-radius: var(--radius-lg) var(--radius-lg) 0 0; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
    .modal-small { border-radius: var(--radius-lg); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border-color); }
    .modal-header h2 { font-size: 18px; font-weight: 600; }
    .modal-body { padding: 16px; }
    .modal-body p { color: var(--text-secondary); margin-bottom: 16px; }
    .modal-actions { display: flex; gap: 12px; }
    .modal-actions .btn { flex: 1; }
    .toast { position: fixed; bottom: calc(var(--nav-height) + 24px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text-primary); color: white; padding: 12px 24px; border-radius: var(--radius-full); font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.3s ease; z-index: 300; }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .settings-section { background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
    .settings-section-header { padding: 14px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); }
    .settings-section-header h3 { font-size: 14px; font-weight: 600; }
    .settings-section-body { padding: 16px; }
    .settings-section-body p { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; }
    .settings-buttons { display: flex; flex-direction: column; gap: 10px; }
    .settings-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
    .stat-card { background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-md); text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 12px; color: var(--text-tertiary); }
    .file-input-hidden { display: none; }
    .import-label { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 14px 20px; font-size: 16px; font-weight: 600; background: var(--bg-tertiary); color: var(--text-primary); border-radius: var(--radius-lg); cursor: pointer; }
    .import-label:hover { background: var(--border-color); }
    .import-label svg { width: 18px; height: 18px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const DEFAULT_AISLES = [
      { id: 'fruits-legumes', name: 'Fruits & Légumes', color: '#4ade80' },
      { id: 'boucherie', name: 'Boucherie / Poissonnerie', color: '#f87171' },
      { id: 'cremerie', name: 'Crèmerie', color: '#fbbf24' },
      { id: 'epicerie', name: 'Épicerie', color: '#a78bfa' },
      { id: 'surgeles', name: 'Surgelés', color: '#60a5fa' },
      { id: 'boissons', name: 'Boissons', color: '#2dd4bf' },
      { id: 'pain', name: 'Pain / Pâtisserie', color: '#f59e0b' },
      { id: 'hygiene', name: 'Hygiène', color: '#ec4899' },
      { id: 'autres', name: 'Autres', color: '#94a3b8' },
    ];

    const DEFAULT_INGREDIENTS = [
      { id: 'tomates', name: 'Tomates', aisleId: 'fruits-legumes' },
      { id: 'oignons', name: 'Oignons', aisleId: 'fruits-legumes' },
      { id: 'ail', name: 'Ail', aisleId: 'fruits-legumes' },
      { id: 'carottes', name: 'Carottes', aisleId: 'fruits-legumes' },
      { id: 'pommes-de-terre', name: 'Pommes de terre', aisleId: 'fruits-legumes' },
      { id: 'poulet', name: 'Poulet', aisleId: 'boucherie' },
      { id: 'boeuf-hache', name: 'Bœuf haché', aisleId: 'boucherie' },
      { id: 'lardons', name: 'Lardons', aisleId: 'boucherie' },
      { id: 'oeufs', name: 'Œufs', aisleId: 'cremerie' },
      { id: 'beurre', name: 'Beurre', aisleId: 'cremerie' },
      { id: 'lait', name: 'Lait', aisleId: 'cremerie' },
      { id: 'creme-fraiche', name: 'Crème fraîche', aisleId: 'cremerie' },
      { id: 'fromage-rape', name: 'Fromage râpé', aisleId: 'cremerie' },
      { id: 'pates', name: 'Pâtes', aisleId: 'epicerie' },
      { id: 'riz', name: 'Riz', aisleId: 'epicerie' },
      { id: 'huile-olive', name: "Huile d'olive", aisleId: 'epicerie' },
      { id: 'sel', name: 'Sel', aisleId: 'epicerie' },
      { id: 'poivre', name: 'Poivre', aisleId: 'epicerie' },
    ];

    const STORAGE_KEYS = { aisles: 'mescourses_aisles', ingredients: 'mescourses_ingredients', recipes: 'mescourses_recipes', recurringProducts: 'mescourses_recurring', productGroups: 'mescourses_groups' };
    const generateId = () => Math.random().toString(36).substr(2, 9);
    const loadFromStorage = (key, defaultValue) => { try { const stored = localStorage.getItem(key); return stored ? JSON.parse(stored) : defaultValue; } catch { return defaultValue; } };
    const saveToStorage = (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error('Erreur:', e); } };

    const Icons = {
      recipes: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="8" y1="7" x2="16" y2="7"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
      ingredients: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
      recurring: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
      list: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="15" y2="16"/></svg>,
      settings: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
      plus: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      trash: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
      edit: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      check: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
      close: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
      back: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
      copy: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
      image: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
      download: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
      upload: <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
      drag: <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>,
    };

    function ConfirmDialog({ isOpen, onClose, onConfirm, title, message, confirmText = "Supprimer" }) {
      if (!isOpen) return null;
      return (<div className="modal-overlay" onClick={onClose}><div className="modal-content modal-small" onClick={e => e.stopPropagation()}><div className="modal-header"><h2>{title}</h2></div><div className="modal-body"><p>{message}</p><div className="modal-actions"><button className="btn btn-secondary" onClick={onClose}>Annuler</button><button className="btn btn-danger" onClick={onConfirm}>{confirmText}</button></div></div></div></div>);
    }

    function Toast({ message, isVisible }) { return <div className={`toast ${isVisible ? 'visible' : ''}`}>{message}</div>; }

    // RECIPES TAB
    function RecipesTab({ recipes, setRecipes, ingredients, aisles }) {
      const [editingRecipe, setEditingRecipe] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const handleSave = (recipe) => { if (recipe.id) { setRecipes(recipes.map(r => r.id === recipe.id ? recipe : r)); } else { setRecipes([...recipes, { ...recipe, id: generateId() }]); } setShowForm(false); setEditingRecipe(null); };
      const handleDelete = (id) => { setRecipes(recipes.filter(r => r.id !== id)); setDeleteConfirm(null); };
      if (showForm) return <RecipeForm recipe={editingRecipe} ingredients={ingredients} aisles={aisles} onSave={handleSave} onCancel={() => { setShowForm(false); setEditingRecipe(null); }} />;
      return (
        <div className="tab-content">
          <div className="tab-header"><h1>Mes Recettes</h1><button className="btn btn-primary btn-with-icon" onClick={() => setShowForm(true)}>{Icons.plus}<span>Ajouter</span></button></div>
          {recipes.length === 0 ? (<div className="empty-state"><div className="empty-icon">{Icons.recipes}</div><p>Aucune recette pour le moment</p><button className="btn btn-primary" onClick={() => setShowForm(true)}>Créer ma première recette</button></div>) : (
            <div className="recipes-grid">{recipes.map(recipe => (<div key={recipe.id} className="recipe-card"><div className="recipe-image">{recipe.image ? <img src={recipe.image} alt={recipe.name} /> : <div className="recipe-image-placeholder">{Icons.image}</div>}</div><div className="recipe-info"><h3>{recipe.name}</h3><p className="recipe-ingredients-count">{recipe.ingredientIds.length} ingrédient{recipe.ingredientIds.length > 1 ? 's' : ''}</p></div><div className="recipe-actions"><button className="btn-icon" onClick={() => { setEditingRecipe(recipe); setShowForm(true); }}>{Icons.edit}</button><button className="btn-icon btn-icon-danger" onClick={() => setDeleteConfirm(recipe.id)}>{Icons.trash}</button></div></div>))}</div>
          )}
          <ConfirmDialog isOpen={deleteConfirm !== null} onClose={() => setDeleteConfirm(null)} onConfirm={() => handleDelete(deleteConfirm)} title="Supprimer la recette" message="Êtes-vous sûr de vouloir supprimer cette recette ?" />
        </div>
      );
    }

    function RecipeForm({ recipe, ingredients, aisles, onSave, onCancel }) {
      const [name, setName] = useState(recipe?.name || '');
      const [image, setImage] = useState(recipe?.image || '');
      const [selectedIngredients, setSelectedIngredients] = useState(recipe?.ingredientIds || []);
      const [searchTerm, setSearchTerm] = useState('');
      const handleImageChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setImage(reader.result); reader.readAsDataURL(file); } };
      const toggleIngredient = (id) => setSelectedIngredients(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      const filteredIngredients = ingredients.filter(ing => ing.name.toLowerCase().includes(searchTerm.toLowerCase()));
      const groupedIngredients = useMemo(() => { const groups = {}; filteredIngredients.forEach(ing => { const aisle = aisles.find(a => a.id === ing.aisleId); const aisleName = aisle ? aisle.name : 'Autres'; if (!groups[aisleName]) groups[aisleName] = []; groups[aisleName].push(ing); }); return groups; }, [filteredIngredients, aisles]);
      const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return; onSave({ id: recipe?.id, name: name.trim(), image, ingredientIds: selectedIngredients }); };
      return (
        <div className="form-page">
          <div className="form-header"><button className="btn-icon" onClick={onCancel}>{Icons.back}</button><h1>{recipe ? 'Modifier la recette' : 'Nouvelle recette'}</h1></div>
          <form onSubmit={handleSubmit}>
            <div className="form-group"><label>Nom de la recette</label><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Pâtes carbonara" required /></div>
            <div className="form-group"><label>Photo</label><div className="image-upload">{image ? (<div className="image-preview"><img src={image} alt="Aperçu" /><button type="button" className="btn-remove-image" onClick={() => setImage('')}>{Icons.close}</button></div>) : (<label className="image-upload-placeholder">{Icons.image}<span>Ajouter une photo</span><input type="file" accept="image/*" onChange={handleImageChange} /></label>)}</div></div>
            <div className="form-group"><label>Ingrédients ({selectedIngredients.length} sélectionné{selectedIngredients.length > 1 ? 's' : ''})</label><input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Rechercher un ingrédient..." className="search-input" /><div className="ingredients-selector">{Object.entries(groupedIngredients).map(([aisleName, items]) => (<div key={aisleName} className="ingredient-group"><h4>{aisleName}</h4><div className="ingredient-chips">{items.map(ing => (<button key={ing.id} type="button" className={`chip ${selectedIngredients.includes(ing.id) ? 'selected' : ''}`} onClick={() => toggleIngredient(ing.id)}>{ing.name}{selectedIngredients.includes(ing.id) && <span className="chip-check">{Icons.check}</span>}</button>))}</div></div>))}</div></div>
            <div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onCancel}>Annuler</button><button type="submit" className="btn btn-primary" disabled={!name.trim()}>{recipe ? 'Enregistrer' : 'Créer'}</button></div>
          </form>
        </div>
      );
    }

    // INGREDIENTS TAB
    function IngredientsTab({ ingredients, setIngredients, aisles, setAisles }) {
      const [showForm, setShowForm] = useState(false);
      const [editingIngredient, setEditingIngredient] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [showAisleManager, setShowAisleManager] = useState(false);
      const [searchTerm, setSearchTerm] = useState('');
      const filteredIngredients = ingredients.filter(ing => ing.name.toLowerCase().includes(searchTerm.toLowerCase()));
      const groupedIngredients = useMemo(() => { const groups = {}; aisles.forEach(aisle => { groups[aisle.id] = { aisle, items: filteredIngredients.filter(ing => ing.aisleId === aisle.id) }; }); return groups; }, [filteredIngredients, aisles]);
      const handleSave = (ingredient) => { if (ingredient.id) { setIngredients(ingredients.map(i => i.id === ingredient.id ? ingredient : i)); } else { setIngredients([...ingredients, { ...ingredient, id: generateId() }]); } setShowForm(false); setEditingIngredient(null); };
      const handleDelete = (id) => { setIngredients(ingredients.filter(i => i.id !== id)); setDeleteConfirm(null); };
      if (showAisleManager) return <AisleManager aisles={aisles} setAisles={setAisles} ingredients={ingredients} onBack={() => setShowAisleManager(false)} />;
      if (showForm) return <IngredientForm ingredient={editingIngredient} aisles={aisles} onSave={handleSave} onCancel={() => { setShowForm(false); setEditingIngredient(null); }} />;
      return (
        <div className="tab-content">
          <div className="tab-header"><h1>Ingrédients</h1><div className="header-actions"><button className="btn btn-secondary btn-with-icon" onClick={() => setShowAisleManager(true)}>{Icons.settings}<span>Rayons</span></button><button className="btn btn-primary btn-with-icon" onClick={() => setShowForm(true)}>{Icons.plus}<span>Ajouter</span></button></div></div>
          <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Rechercher un ingrédient..." className="search-input" />
          {ingredients.length === 0 ? (<div className="empty-state"><div className="empty-icon">{Icons.ingredients}</div><p>Aucun ingrédient</p><button className="btn btn-primary" onClick={() => setShowForm(true)}>Ajouter un ingrédient</button></div>) : (
            <div className="ingredients-list">{Object.entries(groupedIngredients).map(([aisleId, { aisle, items }]) => { if (items.length === 0) return null; return (<div key={aisleId} className="aisle-section"><div className="aisle-header" style={{ '--aisle-color': aisle.color }}><span className="aisle-dot"></span><h3>{aisle.name}</h3><span className="aisle-count">{items.length}</span></div><div className="aisle-items">{items.map(ingredient => (<div key={ingredient.id} className="ingredient-item"><span>{ingredient.name}</span><div className="item-actions"><button className="btn-icon-small" onClick={() => { setEditingIngredient(ingredient); setShowForm(true); }}>{Icons.edit}</button><button className="btn-icon-small btn-icon-danger" onClick={() => setDeleteConfirm(ingredient.id)}>{Icons.trash}</button></div></div>))}</div></div>); })}</div>
          )}
          <ConfirmDialog isOpen={deleteConfirm !== null} onClose={() => setDeleteConfirm(null)} onConfirm={() => handleDelete(deleteConfirm)} title="Supprimer l'ingrédient" message="Êtes-vous sûr de vouloir supprimer cet ingrédient ?" />
        </div>
      );
    }

    function IngredientForm({ ingredient, aisles, onSave, onCancel }) {
      const [name, setName] = useState(ingredient?.name || '');
      const [aisleId, setAisleId] = useState(ingredient?.aisleId || aisles[0]?.id || '');
      const handleSubmit = (e) => { e.preventDefault(); if (!name.trim() || !aisleId) return; onSave({ id: ingredient?.id, name: name.trim(), aisleId }); };
      return (<div className="form-page"><div className="form-header"><button className="btn-icon" onClick={onCancel}>{Icons.back}</button><h1>{ingredient ? "Modifier l'ingrédient" : 'Nouvel ingrédient'}</h1></div><form onSubmit={handleSubmit}><div className="form-group"><label>Nom</label><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Tomates cerises" required /></div><div className="form-group"><label>Rayon</label><select value={aisleId} onChange={e => setAisleId(e.target.value)} required>{aisles.map(aisle => <option key={aisle.id} value={aisle.id}>{aisle.name}</option>)}</select></div><div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onCancel}>Annuler</button><button type="submit" className="btn btn-primary" disabled={!name.trim() || !aisleId}>{ingredient ? 'Enregistrer' : 'Créer'}</button></div></form></div>);
    }

    function AisleManager({ aisles, setAisles, ingredients, onBack }) {
      const [editingAisle, setEditingAisle] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const getIngredientCount = (aisleId) => ingredients.filter(i => i.aisleId === aisleId).length;
      const handleSave = (aisle) => { if (aisle.id) { setAisles(aisles.map(a => a.id === aisle.id ? aisle : a)); } else { setAisles([...aisles, { ...aisle, id: generateId() }]); } setShowForm(false); setEditingAisle(null); };
      const handleDelete = (id) => { setAisles(aisles.filter(a => a.id !== id)); setDeleteConfirm(null); };
      if (showForm) return <AisleForm aisle={editingAisle} onSave={handleSave} onCancel={() => { setShowForm(false); setEditingAisle(null); }} />;
      return (<div className="form-page"><div className="form-header"><button className="btn-icon" onClick={onBack}>{Icons.back}</button><h1>Gérer les rayons</h1><button className="btn btn-primary btn-with-icon" onClick={() => setShowForm(true)}>{Icons.plus}</button></div><div className="aisles-list">{aisles.map(aisle => (<div key={aisle.id} className="aisle-manager-item" style={{ '--aisle-color': aisle.color }}><div className="aisle-manager-info"><span className="aisle-dot"></span><span className="aisle-name">{aisle.name}</span><span className="aisle-count">{getIngredientCount(aisle.id)} ingrédients</span></div><div className="item-actions"><button className="btn-icon-small" onClick={() => { setEditingAisle(aisle); setShowForm(true); }}>{Icons.edit}</button><button className="btn-icon-small btn-icon-danger" onClick={() => setDeleteConfirm(aisle.id)} disabled={getIngredientCount(aisle.id) > 0}>{Icons.trash}</button></div></div>))}</div><ConfirmDialog isOpen={deleteConfirm !== null} onClose={() => setDeleteConfirm(null)} onConfirm={() => handleDelete(deleteConfirm)} title="Supprimer le rayon" message="Êtes-vous sûr de vouloir supprimer ce rayon ?" /></div>);
    }

    function AisleForm({ aisle, onSave, onCancel }) {
      const [name, setName] = useState(aisle?.name || '');
      const [color, setColor] = useState(aisle?.color || '#60a5fa');
      const colors = ['#4ade80', '#f87171', '#fbbf24', '#a78bfa', '#60a5fa', '#2dd4bf', '#f59e0b', '#ec4899', '#94a3b8', '#8b5cf6'];
      const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return; onSave({ id: aisle?.id, name: name.trim(), color }); };
      return (<div className="form-page"><div className="form-header"><button className="btn-icon" onClick={onCancel}>{Icons.back}</button><h1>{aisle ? 'Modifier le rayon' : 'Nouveau rayon'}</h1></div><form onSubmit={handleSubmit}><div className="form-group"><label>Nom du rayon</label><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Fruits & Légumes" required /></div><div className="form-group"><label>Couleur</label><div className="color-picker">{colors.map(c => <button key={c} type="button" className={`color-option ${color === c ? 'selected' : ''}`} style={{ backgroundColor: c }} onClick={() => setColor(c)} />)}</div></div><div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onCancel}>Annuler</button><button type="submit" className="btn btn-primary" disabled={!name.trim()}>{aisle ? 'Enregistrer' : 'Créer'}</button></div></form></div>);
    }

    // RECURRING TAB with drag & drop
    function RecurringTab({ recurringProducts, setRecurringProducts, productGroups, setProductGroups }) {
      const [showProductForm, setShowProductForm] = useState(false);
      const [showGroupForm, setShowGroupForm] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [editingGroup, setEditingGroup] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [deleteType, setDeleteType] = useState(null);
      const [draggedGroup, setDraggedGroup] = useState(null);
      const groupedProducts = useMemo(() => { const groups = { ungrouped: [] }; productGroups.forEach(g => { groups[g.id] = []; }); recurringProducts.forEach(product => { if (product.groupId && groups[product.groupId]) { groups[product.groupId].push(product); } else { groups.ungrouped.push(product); } }); return groups; }, [recurringProducts, productGroups]);
      const handleSaveProduct = (product) => { if (product.id) { setRecurringProducts(recurringProducts.map(p => p.id === product.id ? product : p)); } else { setRecurringProducts([...recurringProducts, { ...product, id: generateId() }]); } setShowProductForm(false); setEditingProduct(null); };
      const handleSaveGroup = (group) => { if (group.id) { setProductGroups(productGroups.map(g => g.id === group.id ? group : g)); } else { setProductGroups([...productGroups, { ...group, id: generateId() }]); } setShowGroupForm(false); setEditingGroup(null); };
      const handleDelete = () => { if (deleteType === 'product') { setRecurringProducts(recurringProducts.filter(p => p.id !== deleteConfirm)); } else if (deleteType === 'group') { setRecurringProducts(recurringProducts.map(p => p.groupId === deleteConfirm ? { ...p, groupId: null } : p)); setProductGroups(productGroups.filter(g => g.id !== deleteConfirm)); } setDeleteConfirm(null); setDeleteType(null); };
      const handleDragStart = (e, groupId) => { setDraggedGroup(groupId); e.currentTarget.classList.add('dragging'); };
      const handleDragEnd = (e) => { e.currentTarget.classList.remove('dragging'); setDraggedGroup(null); };
      const handleDragOver = (e) => { e.preventDefault(); };
      const handleDrop = (e, targetGroupId) => { e.preventDefault(); if (draggedGroup && draggedGroup !== targetGroupId) { const draggedIndex = productGroups.findIndex(g => g.id === draggedGroup); const targetIndex = productGroups.findIndex(g => g.id === targetGroupId); const newGroups = [...productGroups]; const [removed] = newGroups.splice(draggedIndex, 1); newGroups.splice(targetIndex, 0, removed); setProductGroups(newGroups); } setDraggedGroup(null); };
      const touchStartY = useRef(0);
      const handleTouchStart = (e, groupId) => { touchStartY.current = e.touches[0].clientY; setDraggedGroup(groupId); };
      const handleTouchMove = (e) => { if (!draggedGroup) return; const touch = e.touches[0]; const elements = document.querySelectorAll('.product-group[data-group-id]'); elements.forEach(el => { const rect = el.getBoundingClientRect(); if (touch.clientY >= rect.top && touch.clientY <= rect.bottom) { const targetId = el.getAttribute('data-group-id'); if (targetId && targetId !== draggedGroup) { const draggedIndex = productGroups.findIndex(g => g.id === draggedGroup); const targetIndex = productGroups.findIndex(g => g.id === targetId); if (draggedIndex !== targetIndex) { const newGroups = [...productGroups]; const [removed] = newGroups.splice(draggedIndex, 1); newGroups.splice(targetIndex, 0, removed); setProductGroups(newGroups); } } } }); };
      const handleTouchEnd = () => { setDraggedGroup(null); };
      if (showProductForm) return <ProductForm product={editingProduct} groups={productGroups} onSave={handleSaveProduct} onCancel={() => { setShowProductForm(false); setEditingProduct(null); }} />;
      if (showGroupForm) return <GroupForm group={editingGroup} onSave={handleSaveGroup} onCancel={() => { setShowGroupForm(false); setEditingGroup(null); }} />;
      return (
        <div className="tab-content">
          <div className="tab-header"><h1>Récurrents</h1><div className="header-actions"><button className="btn btn-secondary btn-with-icon" onClick={() => setShowGroupForm(true)}>{Icons.plus}<span>Groupe</span></button><button className="btn btn-primary btn-with-icon" onClick={() => setShowProductForm(true)}>{Icons.plus}<span>Produit</span></button></div></div>
          {recurringProducts.length === 0 ? (<div className="empty-state"><div className="empty-icon">{Icons.recurring}</div><p>Aucun produit récurrent</p><p className="empty-hint">Ces produits seront suggérés lors de la génération de votre liste.</p><button className="btn btn-primary" onClick={() => setShowProductForm(true)}>Ajouter un produit</button></div>) : (
            <div className="products-list" onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
              {productGroups.map(group => { const products = groupedProducts[group.id] || []; if (products.length === 0) return null; return (<div key={group.id} className={`product-group ${draggedGroup === group.id ? 'dragging' : ''}`} data-group-id={group.id} draggable onDragStart={(e) => handleDragStart(e, group.id)} onDragEnd={handleDragEnd} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, group.id)}><div className="group-header"><div className="drag-handle" onTouchStart={(e) => handleTouchStart(e, group.id)}>{Icons.drag}</div><h3>{group.name}</h3><div className="item-actions"><button className="btn-icon-small" onClick={() => { setEditingGroup(group); setShowGroupForm(true); }}>{Icons.edit}</button><button className="btn-icon-small btn-icon-danger" onClick={() => { setDeleteConfirm(group.id); setDeleteType('group'); }}>{Icons.trash}</button></div></div><div className="group-items">{products.map(product => (<div key={product.id} className="product-item"><span>{product.name}</span><div className="item-actions"><button className="btn-icon-small" onClick={() => { setEditingProduct(product); setShowProductForm(true); }}>{Icons.edit}</button><button className="btn-icon-small btn-icon-danger" onClick={() => { setDeleteConfirm(product.id); setDeleteType('product'); }}>{Icons.trash}</button></div></div>))}</div></div>); })}
              {groupedProducts.ungrouped.length > 0 && (<div className="product-group"><div className="group-header"><h3>Sans groupe</h3></div><div className="group-items">{groupedProducts.ungrouped.map(product => (<div key={product.id} className="product-item"><span>{product.name}</span><div className="item-actions"><button className="btn-icon-small" onClick={() => { setEditingProduct(product); setShowProductForm(true); }}>{Icons.edit}</button><button className="btn-icon-small btn-icon-danger" onClick={() => { setDeleteConfirm(product.id); setDeleteType('product'); }}>{Icons.trash}</button></div></div>))}</div></div>)}
            </div>
          )}
          <ConfirmDialog isOpen={deleteConfirm !== null} onClose={() => { setDeleteConfirm(null); setDeleteType(null); }} onConfirm={handleDelete} title={deleteType === 'group' ? 'Supprimer le groupe' : 'Supprimer le produit'} message={deleteType === 'group' ? 'Les produits de ce groupe seront conservés sans groupe.' : 'Êtes-vous sûr de vouloir supprimer ce produit ?'} />
        </div>
      );
    }

    function ProductForm({ product, groups, onSave, onCancel }) {
      const [name, setName] = useState(product?.name || '');
      const [groupId, setGroupId] = useState(product?.groupId || '');
      const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return; onSave({ id: product?.id, name: name.trim(), groupId: groupId || null }); };
      return (<div className="form-page"><div className="form-header"><button className="btn-icon" onClick={onCancel}>{Icons.back}</button><h1>{product ? 'Modifier le produit' : 'Nouveau produit'}</h1></div><form onSubmit={handleSubmit}><div className="form-group"><label>Nom</label><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Papier toilette" required /></div><div className="form-group"><label>Groupe (optionnel)</label><select value={groupId} onChange={e => setGroupId(e.target.value)}><option value="">Sans groupe</option>{groups.map(group => <option key={group.id} value={group.id}>{group.name}</option>)}</select></div><div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onCancel}>Annuler</button><button type="submit" className="btn btn-primary" disabled={!name.trim()}>{product ? 'Enregistrer' : 'Créer'}</button></div></form></div>);
    }

    function GroupForm({ group, onSave, onCancel }) {
      const [name, setName] = useState(group?.name || '');
      const handleSubmit = (e) => { e.preventDefault(); if (!name.trim()) return; onSave({ id: group?.id, name: name.trim() }); };
      return (<div className="form-page"><div className="form-header"><button className="btn-icon" onClick={onCancel}>{Icons.back}</button><h1>{group ? 'Modifier le groupe' : 'Nouveau groupe'}</h1></div><form onSubmit={handleSubmit}><div className="form-group"><label>Nom du groupe</label><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Entretien" required /></div><div className="form-actions"><button type="button" className="btn btn-secondary" onClick={onCancel}>Annuler</button><button type="submit" className="btn btn-primary" disabled={!name.trim()}>{group ? 'Enregistrer' : 'Créer'}</button></div></form></div>);
    }

    // SHOPPING LIST TAB
    function ShoppingListTab({ recipes, ingredients, aisles, recurringProducts, productGroups }) {
      const [step, setStep] = useState('select');
      const [selectedRecipes, setSelectedRecipes] = useState([]);
      const [selectedRecurring, setSelectedRecurring] = useState([]);
      const [checkedItems, setCheckedItems] = useState({});
      const [toast, setToast] = useState({ visible: false, message: '' });
      const toggleRecipe = (id) => setSelectedRecipes(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      const toggleRecurring = (id) => setSelectedRecurring(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      const toggleChecked = (key) => setCheckedItems(prev => ({ ...prev, [key]: !prev[key] }));
      const shoppingList = useMemo(() => { if (step !== 'list') return { byAisle: {}, recurring: [] }; const ingredientCounts = {}; selectedRecipes.forEach(recipeId => { const recipe = recipes.find(r => r.id === recipeId); if (recipe) recipe.ingredientIds.forEach(ingId => { ingredientCounts[ingId] = (ingredientCounts[ingId] || 0) + 1; }); }); const byAisle = {}; Object.entries(ingredientCounts).forEach(([ingId, count]) => { const ingredient = ingredients.find(i => i.id === ingId); if (ingredient) { const aisle = aisles.find(a => a.id === ingredient.aisleId); const aisleKey = aisle?.id || 'autres'; if (!byAisle[aisleKey]) byAisle[aisleKey] = { aisle: aisle || { id: 'autres', name: 'Autres', color: '#94a3b8' }, items: [] }; byAisle[aisleKey].items.push({ id: ingredient.id, name: ingredient.name, count }); } }); Object.values(byAisle).forEach(group => { group.items.sort((a, b) => a.name.localeCompare(b.name)); }); const recurring = selectedRecurring.map(id => recurringProducts.find(p => p.id === id)).filter(Boolean); return { byAisle, recurring }; }, [step, selectedRecipes, selectedRecurring, recipes, ingredients, aisles, recurringProducts]);
      const copyList = () => { let text = '🛒 Liste de courses\n\n'; Object.values(shoppingList.byAisle).forEach(({ aisle, items }) => { text += `📍 ${aisle.name}\n`; items.forEach(item => { const prefix = item.count > 1 ? `×${item.count} ` : ''; const checked = checkedItems[`ing-${item.id}`] ? '✓ ' : '○ '; text += `  ${checked}${prefix}${item.name}\n`; }); text += '\n'; }); if (shoppingList.recurring.length > 0) { text += `📦 Autres produits\n`; shoppingList.recurring.forEach(product => { const checked = checkedItems[`rec-${product.id}`] ? '✓ ' : '○ '; text += `  ${checked}${product.name}\n`; }); } navigator.clipboard.writeText(text).then(() => { setToast({ visible: true, message: 'Liste copiée !' }); setTimeout(() => setToast({ visible: false, message: '' }), 2000); }); };
      const reset = () => { setStep('select'); setSelectedRecipes([]); setSelectedRecurring([]); setCheckedItems({}); };
      const groupedRecurring = useMemo(() => { const groups = { ungrouped: [] }; productGroups.forEach(g => { groups[g.id] = { group: g, items: [] }; }); recurringProducts.forEach(product => { if (product.groupId && groups[product.groupId]) groups[product.groupId].items.push(product); else groups.ungrouped.push(product); }); return groups; }, [recurringProducts, productGroups]);
      if (step === 'select') {
        return (
          <div className="tab-content">
            <div className="tab-header"><h1>Liste de courses</h1></div>
            {recipes.length === 0 ? (<div className="empty-state"><div className="empty-icon">{Icons.list}</div><p>Créez d'abord des recettes</p><p className="empty-hint">Vous pourrez ensuite générer votre liste.</p></div>) : (<><p className="step-instruction">Sélectionnez les recettes pour cette semaine :</p><div className="recipes-select-grid">{recipes.map(recipe => (<div key={recipe.id} className={`recipe-select-card ${selectedRecipes.includes(recipe.id) ? 'selected' : ''}`} onClick={() => toggleRecipe(recipe.id)}><div className="recipe-select-image">{recipe.image ? <img src={recipe.image} alt={recipe.name} /> : <div className="recipe-image-placeholder">{Icons.image}</div>}{selectedRecipes.includes(recipe.id) && <div className="recipe-select-check">{Icons.check}</div>}</div><span className="recipe-select-name">{recipe.name}</span></div>))}</div><div className="step-actions"><button className="btn btn-primary btn-large" disabled={selectedRecipes.length === 0} onClick={() => setStep(recurringProducts.length > 0 ? 'recurring' : 'list')}>{recurringProducts.length > 0 ? 'Suivant' : 'Générer la liste'}<span className="btn-badge">{selectedRecipes.length}</span></button></div></>)}
          </div>
        );
      }
      if (step === 'recurring') {
        return (
          <div className="tab-content">
            <div className="tab-header"><button className="btn-icon" onClick={() => setStep('select')}>{Icons.back}</button><h1>Produits suggérés</h1></div>
            <p className="step-instruction">Cochez les produits à ajouter :</p>
            <div className="recurring-select-list">{productGroups.map(group => { const items = groupedRecurring[group.id]?.items || []; if (items.length === 0) return null; return (<div key={group.id} className="recurring-group"><h3>{group.name}</h3>{items.map(product => (<label key={product.id} className="recurring-item"><input type="checkbox" checked={selectedRecurring.includes(product.id)} onChange={() => toggleRecurring(product.id)} /><span className="checkbox-custom"></span><span>{product.name}</span></label>))}</div>); })}{groupedRecurring.ungrouped.length > 0 && (<div className="recurring-group"><h3>Autres</h3>{groupedRecurring.ungrouped.map(product => (<label key={product.id} className="recurring-item"><input type="checkbox" checked={selectedRecurring.includes(product.id)} onChange={() => toggleRecurring(product.id)} /><span className="checkbox-custom"></span><span>{product.name}</span></label>))}</div>)}</div>
            <div className="step-actions"><button className="btn btn-primary btn-large" onClick={() => setStep('list')}>Générer la liste</button></div>
          </div>
        );
      }
      return (
        <div className="tab-content">
          <div className="tab-header"><button className="btn-icon" onClick={reset}>{Icons.back}</button><h1>Ma liste</h1><button className="btn btn-secondary btn-with-icon" onClick={copyList}>{Icons.copy}<span>Copier</span></button></div>
          <div className="shopping-list">{Object.values(shoppingList.byAisle).map(({ aisle, items }) => (<div key={aisle.id} className="shopping-aisle"><div className="shopping-aisle-header" style={{ '--aisle-color': aisle.color }}><span className="aisle-dot"></span><h3>{aisle.name}</h3></div><div className="shopping-items">{items.map(item => (<label key={item.id} className={`shopping-item ${checkedItems[`ing-${item.id}`] ? 'checked' : ''}`}><input type="checkbox" checked={checkedItems[`ing-${item.id}`] || false} onChange={() => toggleChecked(`ing-${item.id}`)} /><span className="checkbox-custom"></span><span className="item-name">{item.count > 1 && <span className="item-count">×{item.count}</span>}{item.name}</span></label>))}</div></div>))}{shoppingList.recurring.length > 0 && (<div className="shopping-aisle"><div className="shopping-aisle-header" style={{ '--aisle-color': '#6366f1' }}><span className="aisle-dot"></span><h3>Autres produits</h3></div><div className="shopping-items">{shoppingList.recurring.map(product => (<label key={product.id} className={`shopping-item ${checkedItems[`rec-${product.id}`] ? 'checked' : ''}`}><input type="checkbox" checked={checkedItems[`rec-${product.id}`] || false} onChange={() => toggleChecked(`rec-${product.id}`)} /><span className="checkbox-custom"></span><span className="item-name">{product.name}</span></label>))}</div></div>)}</div>
          <Toast message={toast.message} isVisible={toast.visible} />
        </div>
      );
    }

    // SETTINGS TAB
    function SettingsTab({ aisles, setAisles, ingredients, setIngredients, recipes, setRecipes, recurringProducts, setRecurringProducts, productGroups, setProductGroups }) {
      const [toast, setToast] = useState({ visible: false, message: '' });
      const fileInputRef = useRef(null);
      const showToast = (message) => { setToast({ visible: true, message }); setTimeout(() => setToast({ visible: false, message: '' }), 2500); };
      const exportData = () => { const data = { version: 1, exportDate: new Date().toISOString(), aisles, ingredients, recipes, recurringProducts, productGroups }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mes-courses-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Données exportées !'); };
      const importData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = JSON.parse(event.target.result); if (data.aisles) setAisles(data.aisles); if (data.ingredients) setIngredients(data.ingredients); if (data.recipes) setRecipes(data.recipes); if (data.recurringProducts) setRecurringProducts(data.recurringProducts); if (data.productGroups) setProductGroups(data.productGroups); showToast('Données importées !'); } catch (err) { showToast('Erreur: fichier invalide'); } }; reader.readAsText(file); e.target.value = ''; };
      return (
        <div className="tab-content">
          <div className="tab-header"><h1>Paramètres</h1></div>
          <div className="settings-section"><div className="settings-section-header"><h3>📊 Statistiques</h3></div><div className="settings-section-body"><div className="settings-stats"><div className="stat-card"><div className="stat-value">{recipes.length}</div><div className="stat-label">Recettes</div></div><div className="stat-card"><div className="stat-value">{ingredients.length}</div><div className="stat-label">Ingrédients</div></div><div className="stat-card"><div className="stat-value">{recurringProducts.length}</div><div className="stat-label">Produits récurrents</div></div><div className="stat-card"><div className="stat-value">{aisles.length}</div><div className="stat-label">Rayons</div></div></div></div></div>
          <div className="settings-section"><div className="settings-section-header"><h3>💾 Sauvegarde</h3></div><div className="settings-section-body"><p>Exportez vos données pour les sauvegarder ou les transférer sur un autre appareil.</p><div className="settings-buttons"><button className="btn btn-primary btn-large" onClick={exportData}>{Icons.download}<span>Exporter mes données</span></button><label className="import-label">{Icons.upload}<span>Importer des données</span><input type="file" accept=".json" onChange={importData} className="file-input-hidden" ref={fileInputRef} /></label></div></div></div>
          <Toast message={toast.message} isVisible={toast.visible} />
        </div>
      );
    }

    // MAIN APP
    function App() {
      const [activeTab, setActiveTab] = useState('list');
      const [aisles, setAisles] = useState(() => loadFromStorage(STORAGE_KEYS.aisles, DEFAULT_AISLES));
      const [ingredients, setIngredients] = useState(() => loadFromStorage(STORAGE_KEYS.ingredients, DEFAULT_INGREDIENTS));
      const [recipes, setRecipes] = useState(() => loadFromStorage(STORAGE_KEYS.recipes, []));
      const [recurringProducts, setRecurringProducts] = useState(() => loadFromStorage(STORAGE_KEYS.recurringProducts, []));
      const [productGroups, setProductGroups] = useState(() => loadFromStorage(STORAGE_KEYS.productGroups, []));
      useEffect(() => { saveToStorage(STORAGE_KEYS.aisles, aisles); }, [aisles]);
      useEffect(() => { saveToStorage(STORAGE_KEYS.ingredients, ingredients); }, [ingredients]);
      useEffect(() => { saveToStorage(STORAGE_KEYS.recipes, recipes); }, [recipes]);
      useEffect(() => { saveToStorage(STORAGE_KEYS.recurringProducts, recurringProducts); }, [recurringProducts]);
      useEffect(() => { saveToStorage(STORAGE_KEYS.productGroups, productGroups); }, [productGroups]);
      const tabs = [
        { id: 'recipes', label: 'Recettes', icon: Icons.recipes },
        { id: 'ingredients', label: 'Ingrédients', icon: Icons.ingredients },
        { id: 'recurring', label: 'Récurrents', icon: Icons.recurring },
        { id: 'list', label: 'Liste', icon: Icons.list, primary: true },
        { id: 'settings', label: 'Réglages', icon: Icons.settings },
      ];
      return (
        <div className="app">
          <main className="app-main">
            {activeTab === 'recipes' && <RecipesTab recipes={recipes} setRecipes={setRecipes} ingredients={ingredients} aisles={aisles} />}
            {activeTab === 'ingredients' && <IngredientsTab ingredients={ingredients} setIngredients={setIngredients} aisles={aisles} setAisles={setAisles} />}
            {activeTab === 'recurring' && <RecurringTab recurringProducts={recurringProducts} setRecurringProducts={setRecurringProducts} productGroups={productGroups} setProductGroups={setProductGroups} />}
            {activeTab === 'list' && <ShoppingListTab recipes={recipes} ingredients={ingredients} aisles={aisles} recurringProducts={recurringProducts} productGroups={productGroups} />}
            {activeTab === 'settings' && <SettingsTab aisles={aisles} setAisles={setAisles} ingredients={ingredients} setIngredients={setIngredients} recipes={recipes} setRecipes={setRecipes} recurringProducts={recurringProducts} setRecurringProducts={setRecurringProducts} productGroups={productGroups} setProductGroups={setProductGroups} />}
          </main>
          <nav className="bottom-nav">
            {tabs.map(tab => (<button key={tab.id} className={`nav-item ${activeTab === tab.id ? 'active' : ''} ${tab.primary ? 'nav-primary' : ''}`} onClick={() => setActiveTab(tab.id)}><span className="nav-icon">{tab.icon}</span><span className="nav-label">{tab.label}</span></button>))}
          </nav>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
